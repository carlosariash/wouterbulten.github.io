---
layout: post
title: "Using immunohistochemistry for training a deep learning system to segment epithelial tissue"
date: 2019-08-02 11:17
categories: blog tech
tags: [deep learning, prostate cancer, immunohistochemistry, epithelium segmentation]
published: true
description: "We developed a new deep learning method to segment epithelial tissue in digitized hematoxylin and eosin (H&E) stained prostatectomy slides using immunohistochemistry (IHC) as reference standard."
image: /assets/images/peso/ihc_he_overlay.jpg
include_ha_series: false
lazyload_standalone: true
large_twitter_card: true
---

To improve prostate cancer detection and grading algorithms, we required a system that could precisely outline epithelial tissue. Our main idea was that such a system could automatically refine coarse annotations made by human annotators or other deep learning systems.

At first, we trained a system using the [conventional way](/blog/tech/epithelium-segmentation-using-deep-learning/): based on human annotations, we trained a U-Net in a simple patch-based approach. We were hindered by human performance: the system's performance can at most be as best as the annotations of the data. In the case of prostate cancer, the epithelial tissue can express as individual cells, which makes manual annotating data a time-consuming and challenging task. With this project, we set out to develop a novel method to circumvent the need for elaborate manual annotations.

<img class="lazyload" data-src="/assets/images/peso/dataset_examples_2rows-min.jpg" style="max-width: 100%;" alt="Prostate epithelial tissue can express itself in many forms. The first four columns show examples of benign tissue, the last four of prostate cancer. Top row shows the original H&E, the bottom row IHC.">


## Data (the PESO dataset)

We have developed our system using a new dataset of 102 prostatectomy tissue blocks. From each block a new section was cut, stained with H&E and scanned. After scanning, the tissue was destained, restained using immunohistochemistry, and scanned again. All slides were scanned at 20x magnification (pixel resolution 0.24 μm).

We used two markers for the immunohistochemistry: CK8/18 (using DAB) to mark all glandular epithelial tissue (benign and malignant), and P63 (using NovaRED) for the basal cell layer, which is normally present in benign glands but not in malignant glands. Restaining, instead of making consecutive slides, results in an H&E and IHC whole-slide image (WSI) pair for each patient that contains the same tissue.

We have released the H&E images used in this project as a public dataset on Zenodo: the [PESO dataset](https://zenodo.org/record/1485967#.XT8F0ugzb8A). More information on this dataset and how to use it can be found in a [separate blog post](/blog/tech/peso-dataset-whole-slide-image-prosate-cancer/).

<img class="lazyload" data-src="/assets/images/peso/ihc_he_overlay.jpg" style="max-width: 100%;" alt="To train our system we make use of registered H&E and IHC stained slides. Registration makes it possible to transfer annotations from one domain to the other.">


## Method

To train our system, we used a two-step approach. First, we trained a convolutional network to segment epithelium in immunohistochemically (IHC) stained tissue sections applying an epithelial marker (CK8/18 & P63). By applying color deconvolution and subsequent recognition of positively stained pixels, we were able to have extensive training data while preventing the cumbersome and imprecise process of manually annotating epithelial regions.

1. On a subset of the IHC dataset, we applied color deconvolution to select the brown color channel. The resulting mask contains most of the epithelial tissue but also includes artifacts.
2. On this subset, we corrected significant errors by hand. Artifacts were marked as such. Note that this task is only a fraction of the work, instead of annotating individual epithelial cells, only errors have to be annotated in a subset of the slides.
3. We trained a first U-Net on the corrected IHC slides. This network could then be used to generate epithelial masks for all the IHC slides (including the non-corrected slides).
4. We registered the H&E and IHC slides. As they were restained, the masks generated by the IHC network matched the H&E slides perfectly.
5. The final network was trained using the transferred masks.

<br>

<img class="lazyload" data-src="/assets/images/peso/epithelium_segmentation_algorithm.png" style="max-width: 100%;" alt="Method used to segment epithelial tissue. First we train a system to segment epithelial tissue on IHC, later we transfer this to H&E to train the final system.">

## Results

Our system was able to accurately segment epithelial tissue, both in benign and cancerous regions (overall F1 score of 0.893). Even in regions with high grade prostate cancer, the system is able to segment individual cells. Some problems occurred in regions with high inflammation (that can look very similar to epithelial tissue). For a complete overview of all results, including results on an external dataset, please refer to the [paper (Open Access)](https://www.nature.com/articles/s41598-018-37257-4).



<img class="lazyload" data-src="/assets/images/peso/epithelium_testset_results.jpg" style="max-width: 100%;" alt="">

## More info

<br><a href="https://www.nature.com/articles/s41598-018-37257-4" class="btn btn-primary">Read full paper on Scientific Reports</a>

<a href="https://doi.org/10.5281/zenodo.1485966" class="btn btn-primary">Download dataset</a>

This work was financed by a grant from the Dutch Cancer Society (KWF). You can use the following reference if you want to cite the paper:

> Bulten, Wouter, et al. "Epithelium segmentation using deep learning in H&E-stained prostate specimens with immunohistochemistry as reference standard." Scientific reports 9.1 (2019): 864.

Or, if you prefer BibTeX:

```tex
{% raw %}
@article{bulten2019epithelium,
  title={Epithelium segmentation using deep learning in H\&E-stained prostate specimens with immunohistochemistry as reference standard},
  author={Bulten, Wouter and B{\'a}ndi, P{\'e}ter and Hoven, Jeffrey and van de Loo, Rob and Lotz, Johannes and Weiss, Nick and van der Laak, Jeroen and van Ginneken, Bram and Hulsbergen-van de Kaa, Christina and Litjens, Geert},
  journal={Scientific reports},
  volume={9},
  number={1},
  pages={864},
  year={2019},
  publisher={Nature Publishing Group}
}
{% endraw %}
```
